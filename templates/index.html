<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CBSE Chemistry Chatbot</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #0f1117;
      --surface: #1a1d27;
      --surface2: #22263a;
      --border: #2e3250;
      --accent: #6366f1;
      --accent-hover: #4f51d4;
      --user-bg: #6366f1;
      --bot-bg: #1e2235;
      --text: #e8eaf6;
      --text-muted: #8b90b8;
      --source-bg: #16192b;
      --source-border: #363a5c;
      --error: #f87171;
      --radius: 16px;
      --radius-sm: 8px;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      height: 100dvh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
    header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 20px;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }
    .logo {
      width: 36px;
      height: 36px;
      background: var(--accent);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      flex-shrink: 0;
    }
    header h1 { font-size: 17px; font-weight: 600; letter-spacing: -0.2px; }
    header p  { font-size: 12px; color: var(--text-muted); margin-top: 2px; }

    /* ‚îÄ‚îÄ Messages ‚îÄ‚îÄ */
    #messages {
      flex: 1;
      overflow-y: auto;
      padding: 24px 16px;
      display: flex;
      flex-direction: column;
      gap: 20px;
      scroll-behavior: smooth;
    }
    #messages::-webkit-scrollbar { width: 6px; }
    #messages::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

    /* Welcome */
    .welcome {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-muted);
    }
    .welcome .icon { font-size: 48px; margin-bottom: 12px; }
    .welcome h2 { font-size: 22px; font-weight: 600; color: var(--text); margin-bottom: 8px; }
    .welcome p  { font-size: 14px; line-height: 1.6; max-width: 380px; margin: 0 auto; }
    .chips { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; margin-top: 20px; }
    .chip {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 6px 14px;
      font-size: 13px;
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s;
    }
    .chip:hover { border-color: var(--accent); background: var(--surface); }

    /* Message rows */
    .msg-row {
      display: flex;
      gap: 10px;
      max-width: 780px;
      width: 100%;
      margin: 0 auto;
    }
    .msg-row.user { flex-direction: row-reverse; }

    .avatar {
      width: 34px;
      height: 34px;
      border-radius: 50%;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      margin-top: 2px;
    }
    .avatar.bot { background: var(--accent); }
    .avatar.user { background: #374151; }

    .bubble-wrap { display: flex; flex-direction: column; gap: 6px; max-width: calc(100% - 44px); }

    .bubble {
      padding: 12px 16px;
      border-radius: var(--radius);
      font-size: 14.5px;
      line-height: 1.65;
      word-break: break-word;
      white-space: pre-wrap;
    }
    .msg-row.user .bubble {
      background: var(--user-bg);
      border-bottom-right-radius: 4px;
      color: #fff;
    }
    .msg-row.bot .bubble {
      background: var(--bot-bg);
      border-bottom-left-radius: 4px;
      border: 1px solid var(--border);
    }
    .msg-row.bot.error .bubble { border-color: var(--error); color: var(--error); }

    /* Sources */
    .sources {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      padding: 0 2px;
    }
    .sources-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; width: 100%; }
    .source-tag {
      background: var(--source-bg);
      border: 1px solid var(--source-border);
      border-radius: var(--radius-sm);
      padding: 3px 9px;
      font-size: 11.5px;
      color: var(--text-muted);
    }

    /* Typing indicator */
    .typing .bubble {
      display: flex;
      align-items: center;
      gap: 5px;
      padding: 14px 18px;
    }
    .dot {
      width: 7px; height: 7px;
      border-radius: 50%;
      background: var(--text-muted);
      animation: bounce 1.2s infinite ease-in-out;
    }
    .dot:nth-child(2) { animation-delay: 0.2s; }
    .dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes bounce {
      0%, 80%, 100% { transform: translateY(0); opacity: 0.4; }
      40%            { transform: translateY(-6px); opacity: 1; }
    }

    /* ‚îÄ‚îÄ Input area ‚îÄ‚îÄ */
    .input-area {
      flex-shrink: 0;
      padding: 14px 16px;
      background: var(--surface);
      border-top: 1px solid var(--border);
    }
    .input-row {
      display: flex;
      gap: 10px;
      max-width: 780px;
      margin: 0 auto;
      align-items: flex-end;
    }
    textarea {
      flex: 1;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text);
      font-size: 14.5px;
      padding: 11px 14px;
      resize: none;
      outline: none;
      font-family: inherit;
      line-height: 1.5;
      max-height: 160px;
      overflow-y: auto;
      transition: border-color 0.2s;
    }
    textarea::placeholder { color: var(--text-muted); }
    textarea:focus { border-color: var(--accent); }

    button#send {
      background: var(--accent);
      border: none;
      border-radius: var(--radius-sm);
      color: #fff;
      width: 42px;
      height: 42px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: background 0.2s, opacity 0.2s;
    }
    button#send:hover { background: var(--accent-hover); }
    button#send:disabled { opacity: 0.45; cursor: not-allowed; }
    button#send svg { width: 18px; height: 18px; }

    .hint { text-align: center; font-size: 11px; color: var(--text-muted); margin-top: 8px; }

    @media (max-width: 540px) {
      header h1 { font-size: 15px; }
      .bubble { font-size: 13.5px; }
      #messages { padding: 16px 10px; }
    }
  </style>
</head>
<body>

<header>
  <div class="logo">üß™</div>
  <div>
    <h1>CBSE Chemistry Chatbot</h1>
    <p>Powered by NCERT Class 12 Chemistry ¬∑ Gemini AI</p>
  </div>
</header>

<div id="messages">
  <div class="welcome" id="welcome">
    <div class="icon">‚öóÔ∏è</div>
    <h2>Ask me anything about Chemistry</h2>
    <p>I answer questions based on your NCERT Class&nbsp;12 Chemistry textbooks ‚Äî both Part&nbsp;1 and Part&nbsp;2.</p>
    <div class="chips">
      <div class="chip" onclick="fillPrompt(this)">What is hybridisation?</div>
      <div class="chip" onclick="fillPrompt(this)">Explain the noble gas configuration</div>
      <div class="chip" onclick="fillPrompt(this)">What are coordination compounds?</div>
      <div class="chip" onclick="fillPrompt(this)">Describe SN1 and SN2 reactions</div>
    </div>
  </div>
</div>

<div class="input-area">
  <div class="input-row">
    <textarea id="input" rows="1" placeholder="Ask a chemistry question‚Ä¶" autofocus></textarea>
    <button id="send" title="Send">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="22" y1="2" x2="11" y2="13"/>
        <polygon points="22 2 15 22 11 13 2 9 22 2"/>
      </svg>
    </button>
  </div>
  <p class="hint">Press Enter to send ¬∑ Shift+Enter for new line</p>
</div>

<script>
  const messagesEl = document.getElementById("messages");
  const inputEl    = document.getElementById("input");
  const sendBtn    = document.getElementById("send");
  const welcomeEl  = document.getElementById("welcome");
  let   busy = false;

  // Auto-resize textarea
  inputEl.addEventListener("input", () => {
    inputEl.style.height = "auto";
    inputEl.style.height = Math.min(inputEl.scrollHeight, 160) + "px";
  });

  // Send on Enter (Shift+Enter = newline)
  inputEl.addEventListener("keydown", e => {
    if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); send(); }
  });
  sendBtn.addEventListener("click", send);

  function fillPrompt(el) {
    inputEl.value = el.textContent;
    inputEl.dispatchEvent(new Event("input"));
    inputEl.focus();
  }

  function addMessage(role, content, sources) {
    if (welcomeEl) welcomeEl.remove();

    const row = document.createElement("div");
    row.className = "msg-row " + role;

    const avatar = document.createElement("div");
    avatar.className = "avatar " + role;
    avatar.textContent = role === "user" ? "üë§" : "ü§ñ";

    const wrap = document.createElement("div");
    wrap.className = "bubble-wrap";

    const bubble = document.createElement("div");
    bubble.className = "bubble";
    bubble.textContent = content;
    wrap.appendChild(bubble);

    if (sources && sources.length > 0) {
      const srcDiv = document.createElement("div");
      srcDiv.className = "sources";

      const label = document.createElement("span");
      label.className = "sources-label";
      label.textContent = "Sources";
      srcDiv.appendChild(label);

      sources.forEach(s => {
        const tag = document.createElement("span");
        tag.className = "source-tag";
        // Format: "NCERT-Class-12-Chemistry-Part-1" ‚Üí "Part 1"
        tag.textContent = s.replace(/NCERT-Class-12-Chemistry-/i, "").replace(/-/g, " ");
        srcDiv.appendChild(tag);
      });
      wrap.appendChild(srcDiv);
    }

    row.appendChild(avatar);
    row.appendChild(wrap);
    messagesEl.appendChild(row);
    scrollToBottom();
    return { row, bubble };
  }

  function addTypingIndicator() {
    const row = document.createElement("div");
    row.className = "msg-row bot typing";

    const avatar = document.createElement("div");
    avatar.className = "avatar bot";
    avatar.textContent = "ü§ñ";

    const wrap = document.createElement("div");
    wrap.className = "bubble-wrap";

    const bubble = document.createElement("div");
    bubble.className = "bubble";
    bubble.innerHTML = '<div class="dot"></div><div class="dot"></div><div class="dot"></div>';
    wrap.appendChild(bubble);

    row.appendChild(avatar);
    row.appendChild(wrap);
    messagesEl.appendChild(row);
    scrollToBottom();
    return row;
  }

  function scrollToBottom() {
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  async function send() {
    if (busy) return;
    const question = inputEl.value.trim();
    if (!question) return;

    busy = true;
    sendBtn.disabled = true;
    inputEl.value = "";
    inputEl.style.height = "auto";

    addMessage("user", question);
    const typingEl = addTypingIndicator();

    try {
      const res  = await fetch("/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ question }),
      });
      const data = await res.json();
      typingEl.remove();

      if (data.error) {
        const { row } = addMessage("bot", "‚ö†Ô∏è " + data.error, null);
        row.classList.add("error");
      } else {
        addMessage("bot", data.answer, data.sources);
      }
    } catch (err) {
      typingEl.remove();
      const { row } = addMessage("bot", "‚ö†Ô∏è Network error. Please try again.", null);
      row.classList.add("error");
    }

    busy = false;
    sendBtn.disabled = false;
    inputEl.focus();
  }
</script>
</body>
</html>
